
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <title>Входы в здания</title>
        <script type="text/javascript" src="http://maps.api.2gis.ru/1.0"></script>
        <style type="text/css">
            .animated {
                /*stroke-dasharray:3309,3309;*/
            }
        </style>
    </head>
    <body>


        <div id="myMapId" style="width:900px; height:600px; float: left;"></div>
        <svg id="arrowField" xmlns="http://www.w3.org/2000/svg" version="1.1" style="
    position: absolute;
    height: 250px;
    width: 200px;
    z-index: 999;
    top: 208px;
    left: 358px;
" onclick="return true;"></svg>
<div style="padding-left: 950px;">
    <button style='display: block;' onclick="changeStyle('simpleGeom');">Простая стрелка</button>
    <button style='display: block;' onclick="changeStyle('edgeGeom');">Стрелка углом</button>
    <button style='display: block;' onclick="changeStyle('backGeom');">Сложная стрелка</button>
    <div style="height: 20px;"></div>
    <button style='display: block;' onclick="rotateOnAngle(2);">Повернуть по часовой (Стрелка влево)</button>
    <button style='display: block;' onclick="rotateOnAngle(-2);">Повернуть против часовой (Стрелка вправо)</button>
    <div style="height: 20px;"></div>
    <button style='display: block;' onclick="showArrow();">Показать стрелку</button>
    <button style='display: block;' onclick="hideArrow();">Спрятать стрелку</button>
</div>


        <script type="text/javascript">
            var myMap;
            // Создаем обработчик загрузки страницы:
            DG.autoload(function() {
                // Создаем объект карты, связанный с контейнером:
                myMap = new DG.Map('myMapId');
                // Устанавливаем центр карты и коэффициент масштабирования:
                myMap.setCenter(new DG.GeoPoint(37.539395,55.747539),18);
                // Добавляем элемент управления коэффициентом масштабирования:
                myMap.controls.add(new DG.Controls.Zoom());
                myMap.addEventListener(myMap.getContainerId(), 'DgZoomChange', function(evt){ updateArrow();});
            });

            var createSvgObject = function (type, options, id) {
                var options = options || {};
                if(id) {
                    options.id = id;
                }
                var object = document.createElementNS("http://www.w3.org/2000/svg", type);
                for (var key in options) {
                    object.setAttribute(key, options[key]);
                }
                return object;
            }
            var geomType = 'simpleGeom';
            var simpleGeom = {
                //18 : 'M 100 150 L 100 100',
                18 : 'M 100 200 l 0 -50',
                17 : 'M 100 125 L 100 100',
                16 : 'M 100 113 L 100 100'
            }

            var edgeGeom = {
                // 18: 'M 140 180 L 100 180 L 100 100',
                18: 'M 140 180 l -1 0',
                17 : 'M 120 140 L 100 140 L 100 100',
                16 : 'M 110 120 L 100 120 L 100 100'
            }

            var backGeom = {
                // 18: 'M 150 160 L 150 190 L 100 190 L 100 100',
                18: 'M 150 160 l 0 1',
                17: 'M 125 130 L 125 145 L 100 145 L 100 100',
                16: 'M 113 115 L 113 123 L 100 123 L 100 100'
            }
            //50 0 30 0 8 0 3 0
            var animateAllGeoms = {
                simpleGeom: "M 100 200 l 0 -50; M 100 150 l 0 -50; M 100 180 l 0 -50; M 100 150 l 0 -50; M 100 158 l 0 -50; M 100 150 l 0 -50; M 100 153 l 0 -50; M 100 150 l 0 -50;",
                // edgeGeom: "M 140 180 L 100 180 l 0 -30; M 140 180 L 100 180 l 0 -80; M 140 180 L 100 180 l 0 -50; M 140 180 L 100 180 l 0 -80; M 140 180 L 100 180 l 0 -72; M 140 180 L 100 180 l 0 -80; M 140 180 L 100 180 l 0 -77; M 140 180 L 100 180 l 0 -80",
                edgeGeom: "M 140 180 l -1 0; M 140 180 l -40 0; M 140 180 l -40 0 l 0 -1; M 140 180 l -40 0 l 0 -80",
                // backGeom: "M 150 160 L 150 190 L 100 190 l 0 -40; M 150 160 L 150 190 L 100 190 l 0 -90; M 150 160 L 150 190 L 100 190 l 0 -60; M 150 160 L 150 190 L 100 190 l 0 -90; M 150 160 L 150 190 L 100 190 l 0 -82; M 150 160 L 150 190 L 100 190 l 0 -90; M 150 160 L 150 190 L 100 190 l 0 -87; M 150 160 L 150 190 L 100 190 l 0 -90"
                backGeom: "M 150 160 l 0 1; M 150 160 l 0 30; M 150 160 l 0 30 l -1 0; M 150 160 l 0 30 l -50 0; M 150 160 l 0 30 l -50 0 l 0 -1; M 150 160 l 0 30 l -50 0 l 0 -90"
            }

            var rotateAngle = 0;

            var getGeom = function() {
                var ret = 'M 0 0';
                var z = myMap ? myMap.getZoom() : 18;
                if(this[geomType][z]) {
                    ret = this[geomType][z];
                }
                return ret;
            }

            getAnimateTiming = function() {
                if(geomType == 'simpleGeom') return "0; 0.33; 0.495; 0.66; 0.77; 0.88; 0.935; 1";
                if(geomType =='edgeGeom') return "0; 0.33; 0.34; 1";
                else return "0; 0.25; 0.26; 0.5; 0.51; 1";
            }

            getAnimationTime = function() {
                if(geomType == 'simpleGeom') return '0.7s';
                else return "0.5s";
            }

            getAnimateGeoms = function() {
                return animateAllGeoms[geomType];
            }

            var getArrowWidth = function() {
                var width = 4;
                var z = myMap ? myMap.getZoom() : 18;
                if (z == 18) width = 6;
                return width;
            }

            var getArrowStrokeWidth = function() {
                var width = 10;
                var z = myMap ? myMap.getZoom() : 18;
                if (z == 18) width = 12;
                return width;
            }

            var getMarkerName = function() {
                var z = myMap ? myMap.getZoom() : 18;
                return 'url(#arrow-marker-' + z + ')';
            }


            function drawArrow () {
                var svg = document.getElementById('arrowField'),
                    strokeWidth = 5,
                    lineColor = '#4b647d',
                    strokeColor = '#fff',
                    strokeLinecap = 'round',
                    lineOpacity = 0.6;
                    arrow16Geom = {
                        d: "M16,9.002 L4,3.002 3,4.002 6,7.002 6,11.002 3,14.002 4,15.002z",
                        fill: lineColor
                    },
                    arrow17Geom = {
                        d: "M20.5,29.001 L6.5,22.001 5.5,23.001 9.5,27.001 9.5,31.001 5.5,35.001 6.5,36.001z",
                        fill: lineColor
                    },
                    arrow18Geom = {
                        d: "M20,11 L4,3 3,4 7,8 7,14 3,18 4,19z",
                        fill: lineColor
                    },
                    arrow16StrokeGeom = {
                        d: "M19,9.001c0-1.137-0.643-2.174-1.658-2.684l-12-6C4.188-0.261,2.792-0.034,1.879,0.88l-1,1 C0.293,2.466,0,3.233,0,4.002s0.293,1.536,0.879,2.121L3,8.243v1.516L0.879,11.88C0.293,12.466,0,13.233,0,14.001 s0.293,1.535,0.879,2.121l1,1c0.913,0.913,2.309,1.141,3.463,0.563l12-6C18.357,11.176,19,10.138,19,9.001L19,9.001z",
                        fill: strokeColor
                    },
                    arrow17StrokeGeom = {
                        d: "M23.5,29c0-1.137-0.643-2.174-1.658-2.683l-14-7c-1.154-0.578-2.55-0.352-3.463,0.562l-1,1 C2.793,21.465,2.5,22.233,2.5,23.001c0,0.769,0.293,1.536,0.879,2.121l3.121,3.12v1.516l-3.121,3.121 C2.793,33.465,2.5,34.232,2.5,35s0.293,1.535,0.879,2.121l1,1c0.913,0.913,2.309,1.141,3.463,0.563l14-7 C22.857,31.175,23.5,30.137,23.5,29L23.5,29z",
                        fill: strokeColor
                    },
                    arrow18StrokeGeom = {
                        d: "M23,11.001c0-1.139-0.643-2.174-1.658-2.686l-16-7.998C4.188-0.261,2.792-0.034,1.879,0.88 l-1,1C0.293,2.466,0,3.233,0,4.002s0.293,1.536,0.879,2.12L4,9.244v3.515L0.879,15.88C0.293,16.466,0,17.231,0,18.001 c0,0.768,0.293,1.534,0.879,2.12l1,1c0.913,0.913,2.309,1.142,3.463,0.563l16-8C22.357,13.176,23,12.14,23,11.001L23,11.001z",
                        fill: strokeColor
                    },
                    marker16ContGeom = {
                        viewBox: '0 0 19 18',
                        refX: 12,
                        refY: 9,
                        markerHeight: 18,
                        markerWidth: 19,
                        markerUnits: 'userSpaceOnUse',
                        orient: 'auto'
                    },
                    marker17ContGeom = {
                        viewBox: '2.5 19 21 20',
                        refX: 12,
                        refY: 29,
                        markerHeight: 20,
                        markerWidth: 21,
                        markerUnits: 'userSpaceOnUse',
                        orient: 'auto'
                    },
                    marker18ContGeom = {
                        viewBox: '0 0 23 22',
                        refX: 12,
                        refY: 11,
                        markerHeight: 22,
                        markerWidth: 23,
                        markerUnits: 'userSpaceOnUse',
                        orient: 'auto'
                    },
                    animateArrowGeom = {
                        attributeName: 'opacity',
                        attributeType: "CSS",
                        values: "0;1",
                        fill: 'freeze',
                        calcMode: 'linear',
                        dur: '0.2s',
                        begin: 'indefinite'
                    },
                    animateArrowHideGeom = {
                        attributeName: 'opacity',
                        attributeType: "CSS",
                        values: "1;0",
                        fill: 'freeze',
                        calcMode: 'linear',
                        dur: '0.2s',
                        begin: 'indefinite'
                    },

                    animateArrowPathGeom = {
                        attributeName: 'd',
                        fill: 'freeze',
                        values: getAnimateGeoms(),
                        keyTimes: getAnimateTiming(), //"0; 0.33; 0.495; 0.66; 0.77; 0.88; 0.935; 1",
                        dur: getAnimationTime(),
                        begin: 'arrowAnimate.end'
                    }

                    // animateArrowTailGeom =
                    animateArrow = createSvgObject('animate', animateArrowGeom, 'arrowAnimate'),
                    animateArrowPath = createSvgObject('animate', animateArrowPathGeom, 'arrowAnimatePath'),
                    animateArrowPathStroke = createSvgObject('animate', animateArrowPathGeom, 'arrowAnimatePathStroke'),
                    animateArrowHide = createSvgObject('animate', animateArrowHideGeom, 'arrowAnimateHide'),

                    arrow16 = createSvgObject('path', arrow16Geom),
                    arrow16Stroke = createSvgObject('path', arrow16StrokeGeom),

                    arrow17 = createSvgObject('path', arrow17Geom),
                    arrow17Stroke = createSvgObject('path', arrow17StrokeGeom),

                    arrow18 = createSvgObject('path', arrow18Geom),
                    arrow18Stroke = createSvgObject('path', arrow18StrokeGeom),

                    defs = createSvgObject('defs'),

                    markerArrow16Cont = createSvgObject('marker', marker16ContGeom, 'arrow-marker-16'),
                    markerArrow17Cont = createSvgObject('marker', marker17ContGeom, 'arrow-marker-17'),
                    markerArrow18Cont = createSvgObject('marker', marker18ContGeom, 'arrow-marker-18'),

                    arrowPathStroke = createSvgObject('path', {
                        id: 'arrow-stroke',
                        d: getGeom(),
                        'stroke-width': getArrowStrokeWidth(),
                        'stroke-linecap': strokeLinecap,
                        'stroke-linejoin': 'round',
                        stroke: strokeColor,
                        fill: 'none',
                        'marker-end': getMarkerName()

                    }),
                    arrowPath = createSvgObject('path', {
                        id: 'arrow',
                        d: getGeom(),
                        'stroke-width': getArrowWidth(),
                        'stroke-linecap': strokeLinecap,
                        'stroke-linejoin': 'round',
                        stroke: lineColor,
                        fill: 'none'
                    }),
                    arrow = createSvgObject('g', {id: 'arrow-geom', opacity: 0});

                markerArrow16Cont.appendChild(arrow16Stroke);
                markerArrow16Cont.appendChild(arrow16);

                markerArrow17Cont.appendChild(arrow17Stroke);
                markerArrow17Cont.appendChild(arrow17);

                markerArrow18Cont.appendChild(arrow18Stroke);
                markerArrow18Cont.appendChild(arrow18);

                defs.appendChild(markerArrow16Cont);
                defs.appendChild(markerArrow17Cont);
                defs.appendChild(markerArrow18Cont);

                arrow.appendChild(arrowPathStroke);
                arrow.appendChild(arrowPath);
                svg.appendChild(defs);
                svg.appendChild(arrow);
                // svg.appendChild(createSvgObject('circle', {cx: 100, cy:100, r: 1, fill:'red'}))
                // svg.appendChild(arrow16Stroke);
                // svg.appendChild(arrow16);
                arrow.appendChild(animateArrow);
                arrowPath.appendChild(animateArrowPath);
                arrowPathStroke.appendChild(animateArrowPathStroke);
                arrow.appendChild(animateArrowHide);

            }
            function styleArrow() {
                var geom = getGeom();
                arrowPath.setAttribute('d', geom);
                arrowPathStroke.setAttribute('d', geom);
                arrowPath.setAttribute('stroke-width', getArrowWidth());
                arrowPathStroke.setAttribute('stroke-width', getArrowStrokeWidth());
                arrowPathStroke.setAttribute('marker-end', getMarkerName());
                animateArrowPath.endElement();
                animateArrowPathStroke.endElement();
                animateArrowPath.setAttribute('values', getAnimateGeoms());
                animateArrowPathStroke.setAttribute('values', getAnimateGeoms());
                animateArrowPath.setAttribute('keyTimes', getAnimateTiming());
                animateArrowPathStroke.setAttribute('keyTimes', getAnimateTiming());
                animateArrowPath.setAttribute('dur', getAnimationTime());
                animateArrowPathStroke.setAttribute('dur', getAnimationTime());
            }
            function updateArrow() {
                styleArrow();
            }

            function changeStyle(style) {
                geomType = style;
                updateArrow();
            }
            function rotateOnAngle(angle) {
                rotateAngle += angle;
                rotate(rotateAngle);
            }
            function rotate(angle) {
                arrow.setAttribute('transform', "rotate(" + angle + ", 100, 100)");
            }

            drawArrow();

            function hideArrow() {
                animateArrow.endElement();
                animateArrowHide.beginElement();
                updateArrow();
            }

            function showArrow() {
                animateArrow.beginElement();
            }


            function reg_event(event){//обработка события
                if(event.keyCode==37){// стрелка влево
                     rotateOnAngle(1)
                }
                if(event.keyCode==39){// стрелка влево
                     rotateOnAngle(-1)
                }
            }

            if (document.addEventListener) { // FF и другие
                    document.addEventListener('keydown', reg_event,false);
                }
        </script>
    </body>
</html>
