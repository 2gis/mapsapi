<!DOCTYPE html>
<html>
<head>
    <title>DGAjax & DGPromise demo</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="http://maps.api.2gis.ru/2.0/loader.js?pkg=full&mode=debug"></script>
</head>
<body>

<div id="map" style="width: 100%; height: 400px; border: 1px solid #ccc;"></div>

<script type="text/javascript">

    // Avoid `console` errors in browsers that lack a console.
    (function() {
        var method;
        var noop = function () {};
        var methods = [
            'assert', 'clear', 'count', 'debug', 'dir', 'dirxml', 'error',
            'exception', 'group', 'groupCollapsed', 'groupEnd', 'info', 'log',
            'markTimeline', 'profile', 'profileEnd', 'table', 'time', 'timeEnd',
            'timeStamp', 'trace', 'warn'
        ];
        var length = methods.length;
        var console = (window.console = window.console || {});

        while (length--) {
            method = methods[length];

            if (!console[method]) {
                console[method] = noop;
            }
        }
    }());

    L.onLoad(function () {

        var map = new L.Map('map', {
            center: new L.LatLng(54.980206086231, 82.898068362003),
            zoom: 17,
            dgGeoclicker: true
        });

        function initTest () {
            var deferred = L.DG.when.defer(),
                clicked = [];

            function clickReject ( ) {
                deferred.reject(new Error('Rejected by user: '));
            }

            function clickProgress ( event ) {
                event.target.setAttribute('disabled', true);
                clicked.push(event.target);
                deferred.notify(clicked.length);
                if (clicked.length == 3) deferred.resolve(clicked);
            }

            var buttons = document.getElementsByTagName('button');
            for (var i = 0, len = buttons.length; i < len; i++) {
                if ( buttons[i].getAttribute('id') == 'button_reject' ) {
                    L.DomEvent.addListener(buttons[i], 'click',  clickReject);
                } else {
                    L.DomEvent.addListener(buttons[i], 'click',  clickProgress);
                }
            }

            return deferred.promise;
        }

        var testPromise = initTest();

        testPromise.then(
            function(data){
                console.info('testPromise resolved', data);
            },
            function(error){
                console.info('testPromise rejected', error);
            },
            function(progress){
                console.info('testPromise progress', progress);
            }
        );

    });
</script>
<br />
Нажмите любые три кнопки или "reject" для эмуляции ошибки.
<button class="progress">#</button>
<button class="progress">#</button>
<button class="progress">#</button>
<button class="progress">#</button>
<button class="progress">#</button>
<button id="button_reject">reject</button>
</body>
</html>
