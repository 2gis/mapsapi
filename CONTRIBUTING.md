## Содержание
1. [Как принять участие в развитии API карт](#Как-принять-участие-в-развитии-api-карт)
    * [Расскажите о нас](#Расскажите-о-нас)
    * [Сообщайте об ошибках](#Сообщайте-об-ошибках)
    * [Разрабатывайте собственные модули](#Разрабатывайте-собственные-модули)
    * [Участвуйте в исправлении ошибок](#Участвуйте-в-исправлении-ошибок)
    * [Участвуйте в улучшении документации](#Участвуйте-в-улучшении-документации)
2. [Как разработать собственный модуль](#Как-разработать-собственный-модуль)
    * [Инициализация](#Инициализация)
    * [Код модуля](#Код-модуля)
    * [Минификация и подключение](#Минификация-и-подключение)
    * [Разработка сложных модулей](#Разработка-сложных-модулей)
3. [Как внести изменения в исходный код](#Как-внести-изменения-в-исходный-код)
4. [Установка локальной сборки API карт](#Установка-локальной-сборки-api-карт)
5. [Установка окружения для разных ОС](#Установка-окружения-для-разных-ОС)
    * [Mac OS X](#mac-os-x)
    * [Ubuntu](#ubuntu)
    * [Windows](#windows)
6. [Стандарты кодирования](#Стандарты-кодирования)
    * [JavaScript](#javascript)
    * [HTML и CSS](#html-и-css)

## Как принять участие в развитии API карт
Каждый из вас может повлиять на качество API карт и сделать продукт еще лучше. Ниже перечислено несколько способов того, как вы можете это сделать.
### Расскажите о нас
Реализовали качественный проект на API 2ГИС? Напишите об этом в своем блоге или социальной сети, поделитесь своим опытом использования API с другими разработчиками.
### Сообщайте об ошибках
Если вы нашли ошибку в работе API карт или столкнулись с проблемой, сообщите об этом на [форуме обратной связи](https://api2gis.uservoice.com) и мы обязательно поможем вам разобраться с проблемой. Как правило, хорошо локализованная ошибка — это уже половина работы по её исправлению, потому постарайтесь сделать максимально простой пример, на котором воспроизводится ошибка и разместите его в публичном доступе (например, используя [JSFiddle](http://jsfiddle.net/)), также не забудьте указать версию браузера и ОС, чтобы мы смогли воспроизвести ошибку.
### Разрабатывайте собственные модули
Вы можете расширять функциональность API карт под свои потребности при помощи модулей. Прочтите [небольшую инструкцию](#Как-разработать-собственный-модуль), которая поможет написать ваш первый модуль. Если считаете, что модуль будет полезен другим разработчикам, обязательно сообщите нам об этом по адресу api@2gis.ru, мы разместим информацию о нем на официальном сайте 2ГИС, а возможно и включим в базовую поставку API карт.

### Участвуйте в исправлении ошибок
Вы можете самостоятельно исправить найденные ошибки в работе API карт, для этого необходимо ознакомиться с [процессом внесения изменений в исходный код](#Как-внести-изменения-в-исходный-код) и прислать нам [pull request](https://help.github.com/articles/using-pull-requests).
### Участвуйте в улучшении документации
Если какой-то из разделов документации показался недостаточно полным и вы считаете, что его можно улучшить, вы можете сделать это самостоятельно. Для внесения изменений в документацию необходимо:
* найти интересующий вас модуль в папке [src](https://github.com/2gis/maps-api-2.0/tree/master/src) и открыть его содержимое;
* перейти в папку doc и открыть лежащий в ней .md файл;
* нажать кнопку Edit, отредактировать текст документации и нажать кнопку Propose File Change.

Мы рассмотрим ваш pull request с изменениями, при следующем релизе после их принятия они появятся на сайте API 2ГИС.

## Как разработать собственный модуль

Ниже приведен пример разработки простого модуля. С помощью этого модуля мы расширим функционал API карт таким образом, чтобы у пользователей была возможность кликнуть в любой дом на карте и увидеть вокруг него магазины в радиусе 500 метров.

Перед началом разработки рекомендуется ознакомиться со [стандартами кодирования](#Стандарты-кодирования) и [документацией](http://api.2gis.ru/doc/maps/manual/base-classes/) API карт.

### Инициализация

Первое, что необходимо сделать &mdash; это создать отдельный [Github-репозиторий для нашего модуля](https://github.com/2gis/maps-api-2.0-plugin-demo).

И продумать файловую структуру:

    /src   - исходные JS файлы
    /demo  - HTML файлы с примерами использования 
    /dist  - минифицированные JS и CSS файлы, а также изображения
    README.md
    LICENSE.md

### Код модуля
Так как наш модуль довольно простой, он будет состоять всего из одного исходного JS файла, назовем его DGDemoPlugin.js и напишем в нем необходимый для работы код:

    L.DG.DemoPlugin = L.Handler.extend({
        _lastFirms: L.layerGroup(),
   
        addHooks: function() {
            this._map.on('click', this._searchFirms, this);
        },
   
        removeHooks: function() {
            this._map.off('click', this._searchFirms, this);
        },
        
        _searchFirms: function(e) { // (MouseEvent)
            L.DG.ajax({
                url: 'http://catalog.api.2gis.ru/2.0/search',
                data: {
                    what: 'магазин',
                    point: e.latlng.lng + ',' + e.latlng.lat,
                    radius: 500,
                    page_size: 50,
                    type: 'filial',
                    key: 1
                },
                success: L.bind(this._showFirms, this)
            })
        },
   
        _showFirms: function(data) { // (Object)
            var marker,
                firms = data.result.data;
        
            this._lastFirms.clearLayers();
            for (var i = 0; i < firms.length; i++) {
                marker = L.marker([firms[i].geo.lat, firms[i].geo.lon]);
                marker.bindPopup(firms[i].firm.name);
                marker.addTo(this._lastFirms);
            }
            this._lastFirms.addTo(this._map);
        }
    });
    
    L.Map.addInitHook('addHandler', 'demoPlugin', L.DG.DemoPlugin);

Наш модуль предполагает взаимодействие пользователя с картой, потому мы его отнаследовали от класса `L.Handler`. Благодаря этому можно будет контролировать его поведение в процессе исполнения приложения (например, у разработчика будет возможность включить или выключить модуль).

Свойство `_lastFirms` представляет собой группу, в которую мы добавляем маркеры. В нашем случае это необходимо для того, чтоб можно было одной командой удалить с карты маркеры всех магазинов, которые были добавлены после предыдущего клика пользователя, и отобразить новые. 

Методы `addHooks` и `removeHooks` срабатывает в тот момент, когда разработчик конечного приложения включает или отключает наш модуль.

Метод `_searchFirms` отправляет AJAX-запрос к [REST API справочника 2ГИС](http://catalog.api.2gis.ru/doc/2.0/catalog/filial/search-by-what-and-radius) и в случае успешного ответа вызывает метод `_showFirms`.

Метод `_showFirms` удаляет с карты все предыдущие маркеры и показывает новые.

Конструкция `L.Map.addInitHook('addHandler', 'demoPlugin', L.DG.DemoPlugin)` позволяет карте зарегистрировать написанный нами обработчик пользовательских действий, после чего к нему можно будет обратиться по соответствующему имени, например:
    
    map.demoPlugin.enable();

### Минификация и подключение
Для минификации JS файлов существует множество популярных инструментов, вы можете воспользоваться любым из них, напрмиер [YUI Compressor](http://yui.github.io/yuicompressor/). Минифицированный JS файл необходимо положить в папку `dist` и предоставить к нему публичный доступ, после чего любой разработчик сможет подключить и использовать его вместе с API карт. Пример подключения модуля:

    L.DG.then(function() {
        //загрузка модуля
        return L.DG.plugin('https://raw.github.com/2gis/maps-api-2.0-plugin-demo/master/dist/DGDemoPlugin.js');
    })
    .then(function() {
        //инициализация карты
        var map = new L.Map('map', {
            'center': new L.LatLng(54.980206086231, 82.898068362003),
            'zoom': 15,
            'geoclicker': false
        });
        // включение модуля
        map.demoPlugin.enable();
    });

### Разработка сложных модулей
TODO

## Как внести изменения в исходный код
Для внесения изменений в исходный код API карт (например, для исправления ошибки) вам потребуется:
* сделать [форк](https://help.github.com/articles/fork-a-repo) репозитория API карт;
* [установить API карт локально](#Установка-локальной-сборки-api-карт) на своем компьютере;
* сделать ветку, название которой будет соответствовать сути вашего изменения (ветку необходимо унаследовать от ветки `master`, так как в ней находится последняя стабильная версия API карт);
* внести свои изменения в код (рекомендуется следовать принятым [стандартам кодирования](#Стандарты-кодирования));
* прислать нам pull request.

После изучения и тестирования pull request-а мы его примем (возможно с некоторыми доработками), после чего они попадут в релиз и станут доступны всем пользователям API карт.

Пожалуйста, не забывайте покрывать код тестами и обновлять документацию.

Для запуска тестов в PhantomJS (по умолчанию) необходимо из консоли выполнить команду:

    grunt test
    
Для запуска тестов в браузерах вашей операционной системы укажите названия браузеров с помощью параметров:

    grunt test --ff --chrome

Список доступных параметров:

    (default)   PhantomJS
    --chrome    Chrome
    --ff        Firefox
    --opera     Opera
    --safari    Safari
    --ie        IE (только для Windows)

Также вы можете проверить код на наличие синтаксических ошибок, для этого необходимо выполнить команду:

    grunt hint

## Установка локальной сборки API карт
Ниже перечислены шаги, которые необходимо выполнить для установки API карт локально на своем компьютере.

* Склонируйте репозиторий:

        git clone git@github.com:2gis/maps-api-2.0.git mapsapi-folder

    Примечание: если вы устанавливаете API карт не с текущего репозитория, а с его форка, тогда не забудьте указать первым параметром команды `clone` адрес форка вместо адреса репозитория 2ГИС.
* Установите окружение:
    * [Node.js](http://nodejs.org/);
    * [GruntJS](http://gruntjs.com/);
    * [PhantomJS](http://phantomjs.org/download.html) (не является обязательным, но необходим для запуска тестов).
    
    Дополнительно вы можете [ознакомиться с инструкцией](#Установка-окружения-для-разных-ОС) по установке окружения для разных операционных систем.
* Установите зависимости:

        cd ~/mapsapi-folder
        npm install

* Выполните сборку API карт:

        grunt build

* Запустите сервер приложения:

        node app

После выполнения описанных выше действий вы сможете открыть в браузере карту по адресу http://127.0.0.1:3000/

## Установка окружения для разных ОС
### Mac OS X

* Установите NodeJS с помощью [NodeJS Installer](http://nodejs.org/download/). Или с помощью homebrew:
    
        brew install node

* Установите Grunt из командной строки:

        npm install -g grunt-cli

* Установите PhantomJS с помощью [PhantomJS Installer](http://phantomjs.org/download.html). Или с помощью homebrew:

        brew update && brew install phantomjs

### Ubuntu

* Установите NodeJS из командной строки:

        sudo apt-get install python-software-properties
        sudo add-apt-repository -y ppa:chris-lea/node.js
        sudo apt-get update
        sudo apt-get install nodejs

* Установите Grunt из командной строки:

        npm install -g grunt-cli

* Установите PhantomJS из командной строки:

        cd /usr/local/share
        sudo wget http://phantomjs.googlecode.com/files/phantomjs-1.8.1-linux-x86_64.tar.bz2
        sudo tar xjf phantomjs-1.8.1-linux-x86_64.tar.bz2
        sudo ln -s /usr/local/share/phantomjs-1.8.1-linux-x86_64/bin/phantomjs /usr/local/share/phantomjs
        sudo ln -s /usr/local/share/phantomjs-1.8.1-linux-x86_64/bin/phantomjs /usr/local/bin/phantomjs
        sudo ln -s /usr/local/share/phantomjs-1.8.1-linux-x86_64/bin/phantomjs /usr/bin/phantomjs
        sudo apt-get install libfontconfig1

### Windows

* Установите NodeJS с помощью [NodeJS Installer](http://nodejs.org/download/)

* Установите Grunt из командной строки:

        npm install -g grunt-cli

* Установите PhantomJS, для этого скачайте [архив](http://phantomjs.org/download.html) и распакуйте его содержимое в папку C:\Program Files\PhantomJS\

## Стандарты кодирования

### JavaScript
Основные требования к JavaScript коду обеспечиваются синтаксическим анализатором и описаны в конфигурационом файле [jsHint](https://github.com/2gis/maps-api-2.0/blob/master/.jshintrc). В процессе разработки мы стараемся придерживаться соглашений, схожими с [Airbnb style guide](https://github.com/airbnb/javascript), за исключением соглашений о [пробелах](https://github.com/airbnb/javascript#whitespace) и [комментариях](https://github.com/airbnb/javascript#comments).

### HTML и CSS
#### Определения
Данные соглашения &mdash; набор правил разной степени обязательности исполнения. Используется три степени:
* обязательно &mdash; нарушение правила не имеет смысла либо полностью запрещено. Нарушение должно обсуждаться заранее с командой;
* должно &mdash; нарушение правила возможно при достаточном обосновании. Нарушение можно обсудить постфактум или оставить комментарий в коде;
* рекомендуется &mdash; при прочих равных лучше использовать рекомендованный вариант.

Соглашения являются расширением методологии [БЭМ](http://ru.bem.info/method/definitions/), поэтому используются следующие термины:
* блок &mdash; синоним понятий "плагин", "модуль" &mdash; неразрывная независимая часть ветки DOM дерева (или ветка целиком), и связанных с ней CSS правил, которая может быть переиспользована на любом проекте, в любом контексте. Блоком так же называется корневой тег такой структуры;
* элемент &mdash; структурная единица блока. Элемент всегда принадлежит одной копии блока. Элемент не имеет смысла вне блока. Элемент не может принадлежать одновременно нескольким блокам, или нескольким копиям одного блока. При движении от элемента вверх по DOM дереву можно встретить любое число других элементов того же блока, либо сам блок. Нельзя встретить элементы других блоков или другие блоки;
* модификатор &mdash; синоним понятия "состояние". Модификатор реализует наследование блоков &mdash; когда нам нужен второй блок, очень похожий на первый. Модификатор всегда относится к какому-то конкретному блоку или элементу. У любого блока и элемента может быть несколько модификаторов, по несколько значений у каждого.

#### Область применения

Данное соглашение применяется для вновь создаваемых блоков (модулей). Сюда относится замена блока при рефакторинге. Соглашение имеет слабое влияние при небольших работах со старым кодом, а также при переиспользовании сторонних модулей.

#### HTML
* верстка должна быть [валидным](http://validator.w3.org/#validate_by_input+with_options) html5 кодом;
* код должен быть максимально семантичным;
* код должен быть в нижнем регистре;
* рекомендуется не указывать типы для тегов script и link;
* рекомендуется пропускать строку перед блоками, списками, таблицами и т.д.;
* должны использоваться двойные кавычки в атрибутах HTML.

##### Рекомендуется использовать теги html5
* article &mdash; выделение смысловой самостоятельной единицы (обычно блока);
* address &mdash; тег для адреса;
* aside &mdash; тег для сопутствующей информации, например "конкуренты";
* time &mdash; тег для любого времени или даты;
* header и footer для явно выраженной шапки и футера блока, если такие есть;
* а также: summary, nav и другие.

Существующие теги и их назначение: http://www.w3.org/TR/html-markup/elements.html#elements

* обязательно используются атрибуты [schema.org](http://schema.org/docs/gs.html#microdata_how);
* не желательно использовать "табличные" теги: table, tr, td, tbody (кроме как по их прямому назначению &mdash; для отображения таблиц);
* запрещено использование устаревших тегов: font, blink и прочее;
* у каждого тега, который будет иметь визуальное представление на странице, должен быть CSS класс (полное покрытие тегов классами).

##### Структура
* должна использоваться методология БЭМ;
* любая визуальная HTML нода должна быть покрыта CSS классом;
* Структура HTML должна быть семантичной и минимально зависеть от дизайна. Иными словами, по HTML коду должно быть всё понятно о содержимом страницы, но ничего не понятно о её дизайне.

Плохо:

    <div class="outer-wrapper">
        <div class="inner-wrapper">
            <div class="right clerafix">Какой-то <span class="red">текст</span></div>
        </div>
    </div>

Хорошо:

    <article class="dg-card dg-card_type_org dg-card_spec_edu" itemscope itemtype="http://schema.org/EducationalOrganization">
        <header class="dg-card__header">
            <h1 class="dg-card__name" itemprop="name">Школа №176</h1>
        </header>
        <address class="dg-card__address" itemprop="streetAddress">Красный проспект, д. 348</address>
    </article>

Приветствуется минимизация DOM дерева (исключение различных оберток, оболочек, разделителей, однопиксельных gif-файлов и т.п.).

##### Общий пример

    <div class="dg-board">
        <div class="dg-board__list">
            <div class="dg-filters">...</div>
            <article class="dg-card" itemscope itemtype="http://schema.org/EducationalOrganization">
                <header class="dg-card__header">
                    <h1 class="dg-card__name" itemprop="name">Школа №176</h1>
                </header>
                <address class="dg-card__address" itemprop="streetAddress">Красный проспект, д. 348</address>
            </article>
            <article class="dg-card">...</article>
            <article class="dg-card">...</article>
        </div>
    </div>

#### CSS
##### Именование классов
* обязательно используется методология БЭМ для именования всех CSS классов;
* для блоков должен использоваться префикс .dg-, например: .dg-fullscreen;
* любой CSS класс должен начинаться с имени блока;
* любой класс по своему предназначению и правилам составления имени должен быть блоком, элементом, или модификатором;
* модификатор обязан иметь четкое описание-комментарий;
* запрещено использовать в имени блока любые символы, кроме a-z, 0-9 и "-", а в качестве первого символа любые, кроме a-z. То же касается составных частей элементов и модификаторов;
* должны использоваться одинарные кавычки;
* должны использоваться короткие 16-тиричные числа, когда это возможно (#ffffff -> #fff);
* рекомендуется использовать сокращенные названия свойств CSS;
* не рекомендуется использовать нули перед точкой в дробных числах, единицы измерения после нулевых значений.

Примеры классов блоков: .dg-search, .dg-popup, .dg-card, .dg-firm-list.

* имя любого элемента обязательно имеет префикс .block__, где "block" &mdash; имя блока, которому принадлежит этот элемент.

Примеры классов элементов: .dg-card__name, .dg-search__query, .dg-popup__close.

* имя модификатора обязательно имеет префикс block_ или block__elem_ и состоит из двух частей: имя модификатора и значение модификатора.

Примеры классов модификаторов:
* .dg-card_type_firm - тип карточки "фирма";
* .dg-search_mode_metro - режим строки поиска "метро";
* .dg-popup_state_hidden - состояние коллаута "скрыт";
* .dg-board__list_state_minimized - состояние элемента "список" равно "свёрнут".

Модификаторы:

* любой модификатор обязательно относится только к какому-то конкретному элементу или блоку;
* разрешено использовать несколько разных модификаторов блока или элемента одновременно (например .dg-card_state_visible и .dg-card_type_building);
* запрещено использовать несколько разных значений одного модификатора или элемента одновременно (например .dg-card_state_hidden и .dg-card_state_visible).

##### Селекторы
* селектор должен состоять только из одного имени класса;
* селекторы по тегам и id крайне не желательны;
* одно состояние одного селектора должно встречаться в CSS 0 или 1 раз;
* селекторы через запятую не желательны. Если такая необходимость сильно выражена, то стоит подумать о создании нового элемента с общими стилями, и его примешиванию к уже существующим в HTML коде;
* классы должны быть сгруппированы вокруг своего блока в порядке: блок, элементы, модификаторы блока. То есть, в потоке CSS одним выделением можно выделить все стили блока и его элементов;
* состояния класса должны быть также сгруппированы: класс, его псевдоклассы, его псевдоэлементы;
* модификаторы блока должны быть сгруппированы по названию модификатора и по его значениям;
* псевдоэлементы before и after должны отделяться от селектора одинарным двоеточием.

##### Свойства
* !important не должен использоваться;
* IE хаки не должны использоваться в основных стилях;
* наличие невалидного CSS должно быть строго обосновано. Используем [CSS валидатор](http://jigsaw.w3.org/css-validator/#validate_by_input);
* любое неочевидное свойство или значение должно поясняться /* комментарием */ на английском языке.
